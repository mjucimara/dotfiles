#!/usr/bin/env bash
set -euo pipefail

DRY_RUN="${DRY_RUN:-0}"

echo "‚õî TOOLBOX RESET"
echo "================"

# Listar toolboxes existentes
mapfile -t TBS < <(toolbox list --containers 2>/dev/null | awk 'NR>1 {print $NF}')

if [[ ${#TBS[@]} -eq 0 ]]; then
  echo "‚ÑπÔ∏è  Nenhuma toolbox encontrada. Nada a fazer."
  exit 0
fi

echo "As seguintes toolboxes ser√£o REMOVIDAS:"
for tb in "${TBS[@]}"; do
  echo " - $tb"
done
echo

if [[ "$DRY_RUN" == "1" ]]; then
  echo "üß™ DRY-RUN ativo. Nada ser√° removido."
  exit 0
fi

read -rp "‚ö†Ô∏è  Isso remover√° TODAS as toolboxes. Continuar? [y/N] " ans
[[ "$ans" != "y" ]] && { echo "‚ùå Opera√ß√£o cancelada."; exit 1; }

echo
echo "üßπ Removendo toolboxes..."
for tb in "${TBS[@]}"; do
  toolbox rm -f "$tb" || true
done

echo
echo "üßπ Removendo imagens toolbox..."
podman images | awk '/toolbox/ {print $3}' | xargs -r podman rmi -f || true

echo
echo "‚úÖ Reset conclu√≠do com sucesso."
