#!/usr/bin/env bash
set -euo pipefail

DOTFILES_DIR="$HOME/.dotfiles"
TEMPLATES_DIR="$DOTFILES_DIR/templates"
PROJECTS_DIR="$HOME/Projects"

usage() {
  echo "Uso: new-project {api|automation|dashboard} [nome]" >&2
  exit 1
}

sanitize() {
  echo "$1" | tr '[:upper:] ' '[:lower:]-' | tr -cd 'a-z0-9-'
}

declare -A TEMPLATES=(
  [api]="template-api-fastapi:api-"
  [automation]="template-automation-python:auto-"
  [dashboard]="template-data-dashboard:dash-"
)

TYPE="${1:-}"
NAME_INPUT="${2:-}"

[[ -z "$TYPE" || -z "${TEMPLATES[$TYPE]:-}" ]] && usage

IFS=":" read -r TEMPLATE_NAME PREFIX <<< "${TEMPLATES[$TYPE]}"
TEMPLATE_DIR="$TEMPLATES_DIR/$TEMPLATE_NAME"

[[ ! -d "$TEMPLATE_DIR" ]] && {
  echo "❌ Template não encontrado: $TEMPLATE_DIR" >&2
  exit 1
}

if [[ -z "$NAME_INPUT" ]]; then
  PROJECT_NAME="${PREFIX}$(date +%Y-%m-%d-%H%M)"
else
  PROJECT_NAME="${PREFIX}$(sanitize "$NAME_INPUT")"
fi

DEST_DIR="$PROJECTS_DIR/$PROJECT_NAME"

[[ -d "$DEST_DIR" ]] && {
  echo "❌ Projeto já existe: $DEST_DIR" >&2
  exit 1
}

mkdir -p "$DEST_DIR"
rsync -a "$TEMPLATE_DIR/" "$DEST_DIR/"

[[ -f "$DEST_DIR/.env.example" ]] && cp "$DEST_DIR/.env.example" "$DEST_DIR/.env"

[[ -x "$DEST_DIR/.post-create.sh" ]] && (cd "$DEST_DIR" && ./.post-create.sh)

echo "✔ Projeto criado com sucesso"
echo "→ $DEST_DIR"
