#!/usr/bin/env bash
set -euo pipefail

# Configura√ß√µes
readonly PROJECTS_DIR="${HOME}/Projects"
readonly TEMPLATES_DIR="${TEMPLATES_DIR:-$HOME/Projects/templates}"


# Valida√ß√£o do argumento
if [[ $# -eq 0 ]]; then
    echo "‚ùå Uso: $0 {api|auto|data}"
    echo "   Ou: tbapi, tbauto, tbdata (com alias)"
    exit 1
fi

TYPE="${1}"
case "${TYPE}" in
    api)
        readonly TOOLBOX_NAME="toolbox-api"
        readonly TEMPLATE_NAME="template-api-fastapi"
        ;;
    auto|automation)
        readonly TOOLBOX_NAME="toolbox-automation"
        readonly TEMPLATE_NAME="template-automation-python"
        ;;
    data|dashboard)
        readonly TOOLBOX_NAME="toolbox-data"
        readonly TEMPLATE_NAME="template-data-dashboard"
        ;;
    *)
        echo "‚ùå Tipo inv√°lido: '${TYPE}'"
        echo "   Op√ß√µes v√°lidas: api, auto/automation, data/dashboard"
        exit 1
        ;;
esac

# Diret√≥rio atual (caminho absoluto, sem symlinks)
CWD="$(pwd -P 2>/dev/null || pwd)"
readonly CWD

# Fun√ß√µes auxiliares
is_inside_projects() {
    [[ "${CWD}" == "${PROJECTS_DIR}"/* ]]
}

has_project_files() {
    [[ -f "${CWD}/pyproject.toml" ]] || [[ -f "${CWD}/Makefile" ]]
}

toolbox_exists() {
    toolbox list --containers 2>/dev/null | awk 'NR>1 {print $NF}' | grep -qFx "${TOOLBOX_NAME}"
}

# Detec√ß√£o do diret√≥rio alvo
TARGET_DIR=""
if is_inside_projects && has_project_files; then
    TARGET_DIR="${CWD}"
    echo "üîç Projeto v√°lido detectado:"
    echo "   ${TARGET_DIR}"
else
    # Verifica se o template existe
    TEMPLATE_PATH="${TEMPLATES_DIR}/${TEMPLATE_NAME}"
    if [[ ! -d "${TEMPLATE_PATH}" ]]; then
        echo "‚ö†Ô∏è  Aviso: Template n√£o encontrado em:"
        echo "   ${TEMPLATE_PATH}"
        echo "   Usando diret√≥rio home como fallback."
        TARGET_DIR="${HOME}"
    else
        TARGET_DIR="${TEMPLATE_PATH}"
        echo "üìÇ Fora de projeto ou sem arquivos de projeto."
        echo "‚û° Template recomendado:"
        echo "   ${TARGET_DIR}"
    fi
fi

readonly TARGET_DIR

# -------- DECIS√ÉO PRINCIPAL --------
echo
if toolbox_exists; then
    echo "üöÄ Toolbox encontrada: ${TOOLBOX_NAME}"
    echo "   Entrando..."
    echo "------------------------------"
    exec toolbox enter "${TOOLBOX_NAME}"
else
    echo "üì¶ Toolbox '${TOOLBOX_NAME}' n√£o encontrada."
    echo "   Criando..."
    echo "------------------------------"
    
    if toolbox create "${TOOLBOX_NAME}" > /dev/null 2>&1; then
        echo "‚úÖ Toolbox criada com sucesso!"
        echo
        echo "‚û° Para entrar, execute:"
        echo "   toolbox enter ${TOOLBOX_NAME}"
        echo
        echo "‚û° Dentro da toolbox, v√° para:"
        echo "   cd ${TARGET_DIR}"
    else
        echo "‚ùå Falha ao criar toolbox!"
        echo "   Verifique se o Podman est√° rodando e tente novamente."
        exit 1
    fi
fi
